#!/usr/bin/env bash
<% if p('pxc_enabled') == true %>
set -e
set -o pipefail

## NOTE: This script MUST ALWAYS run as root user.

export TMPDIR=/var/vcap/data/mysql-clustered/tmp


CONFIG_DIR=/etc/mysql
datadir=/var/vcap/store/mysql-clustered
HEALTHCHECK_LOG_DIR="/var/vcap/sys/log/galera-agent"
JOB_INDEX=<%= index %>
LOG_DIR=/var/vcap/sys/log/mysql-clustered
PXC_JOB_DIR=/var/vcap/jobs/mysql-clustered
RUN_DIR=/var/vcap/sys/run/pxc-ctl
MYSQL_RUN_DIR=/var/vcap/sys/run/mysql-clustered
SECURE_FILE_PRIV=/var/vcap/data/mysql-clustered/files
SERVER_AUDIT_LOG_DIR=/var/vcap/store/mysql_audit_logs
SLOW_QUERY_LOG_FILE=$LOG_DIR/mysql_slow_query.log

source /var/vcap/packages/pxc-utils/logging.sh
source /var/vcap/packages/pxc-utils/pid_utils.sh

if [[ ! -d "$RUN_DIR" ]]; then
  mkdir -p $RUN_DIR
fi
chown -R vcap:vcap $RUN_DIR

if [[ ! -d "$MYSQL_RUN_DIR" ]]; then
  mkdir -p $MYSQL_RUN_DIR
fi
chown -R vcap:vcap $MYSQL_RUN_DIR

log "pre-start setup script: set up ENV and logging"

<% if p('server_audit_logs_enabled') %>
mkdir -p ${SERVER_AUDIT_LOG_DIR}
chown vcap:vcap ${SERVER_AUDIT_LOG_DIR}

# logrotate audit logs
ln -sf /var/vcap/jobs/mysql-clustered/config/mysql_clustered_audit_logs.logrotate /etc/logrotate.d/mysql_clustered_audit_logs
<% end %>

if [[ ! -d "$TMPDIR" ]]; then
  log "pre-start setup script: directory $TMPDIR does not exist, creating it now"
  mkdir -p $TMPDIR
fi
chown -R vcap:vcap $TMPDIR

mkdir -p $SECURE_FILE_PRIV
chmod 0750 $SECURE_FILE_PRIV
chown -R vcap:vcap $SECURE_FILE_PRIV

touch $SLOW_QUERY_LOG_FILE
date >> $SLOW_QUERY_LOG_FILE 2>> $SLOW_QUERY_LOG_FILE
mkdir -p "${HEALTHCHECK_LOG_DIR}"
chown -R vcap:vcap "${HEALTHCHECK_LOG_DIR}"


 /var/vcap/packages/auto-tune-mysql/bin/generate-auto-tune-mysql \
    -f /var/vcap/jobs/mysql-clustered/config/auto-tune.cnf \
    -P <%= p('innodb_buffer_pool_size_percent') %>

ln -sf $PXC_JOB_DIR/config/pxc-sudoers /etc/sudoers.d/pxc-sudoers
chmod 440 /etc/sudoers.d/pxc-sudoers

rm -f /etc/profile.d/disable_mysql_cli_history.sh
<% unless p('cli_history') %>
ln -sf $PXC_JOB_DIR/config/disable_mysql_cli_history.sh /etc/profile.d/disable_mysql_cli_history.sh
<% end %>

ulimit -n <%= p('max_open_files') %>


function check_mysql_disk_persistence() {
  if [[ (! -d /var/vcap/store) || $(mountpoint -d /var/vcap/store) == $(mountpoint -d /) ]]
  then
    err "Persistent disk not found"
    exit 1
  fi
}

function check_mysql_disk_capacity() {
  local datadir_capacity=$(df --block-size=1M --output=target,size /var/vcap/store | awk ' NR==2 { print $2 } ')
  local minimum_required_space_in_mb=5000
  if [[ "${datadir_capacity}" -lt "${minimum_required_space_in_mb}" ]]
  then
    err "Datadir capacity is ${datadir_capacity}MB, which is under the minimum required: ${minimum_required_space}MB"
    exit 1
  fi
}

check_mysql_disk_persistence
check_mysql_disk_capacity

if [ ! -d "${datadir}" ]; then
  log "pre-start setup script: making ${datadir} and running /var/vcap/packages/pxc/bin/mysqld"
  mkdir -p ${datadir}
  /var/vcap/packages/pxc/bin/mysqld \
         --defaults-file=/var/vcap/jobs/mysql-clustered/config/my.cnf \
         --basedir=/var/vcap/packages/pxc \
         --user=vcap \
         --initialize \
         --datadir=${datadir}
fi
chown -R vcap:vcap ${datadir}

rm -f /etc/my.cnf

GALERA_INIT_PREFIX_CMD="su vcap -c -o pipefail" ${PXC_JOB_DIR}/bin/pre-start-execution

if [ -d "/var/vcap/store/mysql" -a ! -f "/var/vcap/store/migrated-successfully" ]; then
  node_count=<%= link('mysql').instances.length %>
  if [ ${node_count} -ne 1 ]; then
    err "You must scale to 1 node before migrating to pxc"
    exit 1
  fi

  MYSQL_USERNAME="<%= p('admin_username') %>" MYSQL_PASSWORD="<%= p('admin_password') %>" /var/vcap/packages/migrate-to-pxc/bin/migrate-to-pxc

  #Prevent cf-mysql-release from starting again with an empty DB
  mv /var/vcap/store/mysql /var/vcap/store/mysql-migration-backup
  mkdir /var/vcap/store/mysql
  chmod 000 /var/vcap/store/mysql

  echo "DO NOT DELETE THIS FILE; YOU WILL LOSE DATA" > /var/vcap/store/migrated-successfully
fi
<% end %>
