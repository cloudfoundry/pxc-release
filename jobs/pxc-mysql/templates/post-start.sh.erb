#!/usr/bin/env bash

<% if p('pxc_enabled') == true %>
set -e
set -o pipefail

<%-
  unless %w[5.7 8.0].include? p('mysql_version')
    raise "Unsupported value '#{p('mysql_version')}' for 'mysql_version' property. Choose from '8.0' or '5.7'"
  end
-%>

## NOTE: This script MUST ALWAYS run as root user.

pxc_maint_mode=$(/var/vcap/packages/percona-xtradb-cluster-<%= p('mysql_version') %>/bin/mysql --defaults-file=/var/vcap/jobs/pxc-mysql/config/mylogin.cnf --execute 'select @@global.pxc_maint_mode != "DISABLED"' -sN)
if [[ $pxc_maint_mode -eq 1 ]]; then
    echo "pxc_maint_mode is on, skipping seeding users and databases"
    exit 0
fi

/var/vcap/packages/percona-xtradb-cluster-<%= p('mysql_version') %>/bin/mysql --defaults-file=/var/vcap/jobs/pxc-mysql/config/mylogin.cnf --execute <(/var/vcap/jobs/pxc-mysql/config/seeded_users_and_databases.sql)

# TODO: look at pre-start.sh.erb's use of logging.sh helpers
echo "post-start: galera-init initialized successfully"
<% end %>
