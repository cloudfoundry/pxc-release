SET @@session.sql_log_bin = off;
<%-
  if p('remote_admin_access')
    hosts = ['%']
    old_hosts = %w{localhost 127.0.0.1 ::1}
  else
    hosts = %w{localhost 127.0.0.1 ::1}
    old_hosts = ['%']
  end
  all_hosts = hosts + old_hosts
-%>
<%- if_p('previous_admin_username') do |previous_username| -%>
  <%- all_hosts.each do |host| -%>
DROP USER IF EXISTS '<%= previous_username %>'@'<%= host %>';
  <%- end -%>
<%- end -%>

<%- all_hosts.each do |host| -%>
DROP USER IF EXISTS 'root'@'<%= host %>';
  <%- if p('admin_username') != 'root' -%>
DROP USER IF EXISTS '<%= p('admin_username') %>'@'<%= host %>';
  <%- end -%>
DROP USER IF EXISTS 'roadmin'@'<%= host %>';

<%- end -%>
<%- if_p('mysql_backup_password') do |password| -%>
CREATE USER IF NOT EXISTS '<%= p('mysql_backup_username') %>'@'localhost';
ALTER USER '<%= p('mysql_backup_username') %>'@'localhost' IDENTIFIED WITH mysql_native_password BY '<%= password %>';
GRANT RELOAD, LOCK TABLES, REPLICATION CLIENT, /*!80001 BACKUP_ADMIN,*/ PROCESS ON *.* to '<%= p('mysql_backup_username') %>'@'localhost';
<%- if p('mysql_version') == "8.0" -%>
GRANT SELECT on performance_schema.keyring_component_status to '<%= p('mysql_backup_username') %>'@'localhost';
GRANT SELECT ON performance_schema.log_status TO '<%= p('mysql_backup_username') %>'@'localhost';
<%- end -%>
<%- end -%>

<%- if_link('galera-agent')  do |link| -%>
CREATE USER IF NOT EXISTS 'galera-agent'@'localhost'
IDENTIFIED WITH mysql_native_password BY '<%= link.p("db_password") %>'
/*!80001 ATTRIBUTE '{ "pxc-release-seeded-user": true }'*/;
ALTER USER 'galera-agent'@'localhost'
IDENTIFIED WITH mysql_native_password BY '<%= link.p("db_password") %>'
/*!80001 ATTRIBUTE '{ "pxc-release-seeded-user": true }'*/;
REVOKE ALL PRIVILEGES ON *.* FROM 'galera-agent'@'localhost';
<%- end -%>

<%- hosts.each do |host| -%>
CREATE USER IF NOT EXISTS '<%= p('admin_username') %>'@'<%= host %>' IDENTIFIED WITH mysql_native_password BY '<%= p('admin_password') %>';
ALTER USER '<%= p('admin_username') %>'@'<%= host %>' IDENTIFIED WITH mysql_native_password BY '<%= p('admin_password') %>';
GRANT ALL PRIVILEGES ON *.* TO '<%= p('admin_username') %>'@'<%= host %>' WITH GRANT OPTION;
GRANT PROXY ON ''@'' TO '<%= p('admin_username') %>'@'<%= host %>' WITH GRANT OPTION;
  <%- if p('roadmin_enabled') -%>

CREATE USER IF NOT EXISTS 'roadmin'@'<%= host %>' IDENTIFIED WITH mysql_native_password BY '<%= p('roadmin_password') %>';
ALTER USER 'roadmin'@'<%= host %>' IDENTIFIED WITH mysql_native_password BY '<%= p('roadmin_password') %>';
GRANT SELECT, PROCESS, REPLICATION CLIENT ON *.* TO 'roadmin'@'<%= host %>';
  <%- end -%>

<%- end -%>

SET @@session.sql_log_bin = on;
